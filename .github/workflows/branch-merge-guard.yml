name: branch-merge-guard

on:
  pull_request:

jobs:
  guard:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read

    steps:
      - name: Enforce branch merge rules
        env:
          BASE: ${{ github.base_ref }}
          HEAD: ${{ github.head_ref }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e

          fail() {
            local message="$1"

            echo "‚ùå $message"

            gh api repos/$REPO/issues/$PR_NUMBER/comments \
              -f body="üö´ **Merge blocked**\n\n$message"

            exit 1
          }

          echo "PR from '$HEAD' to '$BASE'"

          case "$BASE" in

            master)
              if [[ "$HEAD" =~ ^feat/.* || "$HEAD" =~ ^fix/.* || "$HEAD" =~ ^codex/.* || "$HEAD" == "rc" ]]; then
                exit 0
              fi
              fail "Into **master** allowed only from **feat/***, **fix/***, **codex/*** or **rc**."
              ;;

            rc)
              if [[ "$HEAD" == "master" || "$HEAD" == "release" ]]; then
                exit 0
              fi
              fail "Into **rc** allowed only from **master** or **release**."
              ;;

            release)
              if [[ "$HEAD" == "rc" ]]; then
                exit 0
              fi
              fail "Into **release** allowed only from **rc**."
              ;;

            *)
              # All other branches (feat/*, fix/*, codex/* etc.)
              exit 0
              ;;

          esac
